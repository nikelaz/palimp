import { Button, VerticalBox, HorizontalBox, LineEdit, StandardTableView, StandardListView } from "std-widgets.slint";

export component AppWindow inherits Window {
    title: "Palimp GUI";
    width: 800px;
    height: 600px;

    // Data Models - Now using standard table items
    in property <[[StandardListViewItem]]> sites;
    in property <[[StandardListViewItem]]> crawls;
    in property <[[StandardListViewItem]]> queries;
    in property <[[StandardListViewItem]]> results;

    // Callbacks
    callback request_add_site(string, string);
    callback request_delete_site(string); // using string ID for easier parsing
    
    callback request_start_crawl(string, string); // site_id, max_concurrent
    callback request_delete_crawl(string);

    callback request_add_query(string, string); // crawl_id, selector
    callback request_delete_query(string);

    callback request_load_results(string); // query_id

    // Current active section (0 = Sites, 1 = Crawls, 2 = Queries, 3 = Results)
    property <int> current_section: 0;

    HorizontalBox {
        // Left Sidebar Navigation
        StandardListView {
            width: 150px;
            model: [
                { text: "Sites" },
                { text: "Crawls" },
                { text: "Queries" },
                { text: "Results" }
            ];
            current-item <=> root.current_section;
        }

        // Main Content Area
        VerticalBox {
            padding: 20px;
            
            // Sites Section
            if current_section == 0: VerticalBox {
                property <int> right_clicked_site_row: -1;
                
                HorizontalBox {
                    height: 40px;
                    new_domain := LineEdit {
                        placeholder-text: "Domain (e.g., example.com)";
                        width: 200px;
                    }
                    new_sitemap := LineEdit {
                        placeholder-text: "Sitemap URL (e.g., https://example.com/sitemap.xml)";
                        width: 300px;
                    }
                    Button {
                        text: "Add Site";
                        clicked => {
                            root.request_add_site(new_domain.text, new_sitemap.text);
                            new_domain.text = "";
                            new_sitemap.text = "";
                        }
                    }
                }
                
                site_context := ContextMenuArea {
                    
                    
                    
                    StandardTableView {
                        columns: [
                            { title: "ID", width: 50px },
                            { title: "Domain", width: 200px },
                            { title: "Sitemap URL" },
                        ];
                        rows: root.sites;
                        
                        row-pointer-event(row-index, event, point) => {
                            if (event.kind == PointerEventKind.up && event.button == PointerEventButton.right) {
                                right_clicked_site_row = row-index;
                                site_context.show(point);
                            }
                        }
                    }
                    
                    Menu {
                        MenuItem {
                            title: "Delete Site";
                            activated => {
                                if (right_clicked_site_row >= 0 && right_clicked_site_row < root.sites.length) {
                                    root.request_delete_site(root.sites[right_clicked_site_row][0].text);
                                }
                            }
                        }
                    }
                }
            }

            // Crawls Section
            if current_section == 1: VerticalBox {
                property <int> right_clicked_crawl_row: -1;
                
                HorizontalBox {
                    height: 40px;
                    crawl_site_id := LineEdit {
                        placeholder-text: "Site ID";
                        width: 100px;
                    }
                    crawl_concurrency := LineEdit {
                        placeholder-text: "Concurrency (default 5)";
                        text: "5";
                        width: 150px;
                    }
                    Button {
                        text: "Start New Crawl";
                        clicked => {
                            root.request_start_crawl(crawl_site_id.text, crawl_concurrency.text);
                            crawl_site_id.text = "";
                        }
                    }
                }

                crawl_context := ContextMenuArea {
                    
                    
                    
                    StandardTableView {
                        columns: [
                            { title: "ID", width: 50px },
                            { title: "Site", width: 250px },
                            { title: "Started At" },
                        ];
                        rows: root.crawls;
                        
                        row-pointer-event(row-index, event, point) => {
                            if (event.kind == PointerEventKind.up && event.button == PointerEventButton.right) {
                                right_clicked_crawl_row = row-index;
                                crawl_context.show(point);
                            }
                        }
                    }
                    
                    Menu {
                        MenuItem {
                            title: "Delete Crawl";
                            activated => {
                                if (right_clicked_crawl_row >= 0 && right_clicked_crawl_row < root.crawls.length) {
                                    root.request_delete_crawl(root.crawls[right_clicked_crawl_row][0].text);
                                }
                            }
                        }
                    }
                }
            }

            // Queries Section
            if current_section == 2: VerticalBox {
                property <int> right_clicked_query_row: -1;
                
                HorizontalBox {
                    height: 40px;
                    query_crawl_id := LineEdit {
                        placeholder-text: "Crawl ID";
                        width: 100px;
                    }
                    query_selector := LineEdit {
                        placeholder-text: "CSS Selector (e.g., div.content a)";
                        width: 300px;
                    }
                    Button {
                        text: "Run Query";
                        clicked => {
                            root.request_add_query(query_crawl_id.text, query_selector.text);
                            query_crawl_id.text = "";
                            query_selector.text = "";
                        }
                    }
                }

                query_context := ContextMenuArea {
                    
                    
                    
                    StandardTableView {
                        columns: [
                            { title: "ID", width: 50px },
                            { title: "Crawl", width: 250px },
                            { title: "Selector" },
                        ];
                        rows: root.queries;
                        
                        row-pointer-event(row-index, event, point) => {
                            if (event.kind == PointerEventKind.up && event.button == PointerEventButton.right) {
                                right_clicked_query_row = row-index;
                                query_context.show(point);
                            }
                        }
                    }
                    
                    Menu {
                        MenuItem {
                            title: "Delete Query";
                            activated => {
                                if (right_clicked_query_row >= 0 && right_clicked_query_row < root.queries.length) {
                                    root.request_delete_query(root.queries[right_clicked_query_row][0].text);
                                }
                            }
                        }
                    }
                }
            }

            // Results Section
            if current_section == 3: VerticalBox {
                HorizontalBox {
                    height: 40px;
                    results_query_id := LineEdit {
                        placeholder-text: "Query ID to Load";
                        width: 150px;
                    }
                    Button {
                        text: "Load Results";
                        clicked => {
                            root.request_load_results(results_query_id.text);
                        }
                    }
                }

                StandardTableView {
                    columns: [
                        { title: "ID", width: 50px },
                        { title: "Page URL" },
                        { title: "Count", width: 80px },
                    ];
                    rows: root.results;
                }
            }
        }
    }
}
